<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>펀드 추천 시스템</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='result_style.css') }}">
  <style>
    .home-btn {
      position: fixed;
      top: 10px;
      left: 20px;
      z-index: 6000;
      font-size: 0.9rem;
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
      background: linear-gradient(90deg, #5e72e4, #825ee4);
      color: #fff;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    }
    .home-btn:hover {
      background: linear-gradient(90deg, #825ee4, #5e72e4);
      box-shadow: 0 6px 20px rgba(130, 94, 228, 0.2);
      transform: translateY(-2px);
    }
    .btn.active {
      background: #5e72e4 !important;
      color: #fff !important;
      border-color: #5e72e4 !important;
    }
    .card-title a {
      text-decoration: none;
      color: #34495e;
    }
    .card-title a:hover {
      color: #5e72e4;
      text-decoration: underline;
    }
    .badge.bg-rank {
      background: #e9ecef;
      color: #222;
    }
  </style>
</head>
<body>
  <a href="/" class="home-btn">home</a>
  <div class="container mt-5">
    <h2 class="mb-4">펀드 추천 결과 (상위 30개)</h2>

    <!-- 검색창 -->
    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="펀드명을 검색하세요...">
    </div>

    <!-- 테마 필터 버튼 -->
    <div class="mb-4">
      <strong>테마 필터:</strong><br>
      <div id="keywordButtons" class="d-flex flex-wrap gap-2 mt-2"></div>
    </div>

    <!-- 위험등급 필터 -->
    <div class="mb-4">
      <strong>위험 선호도:</strong>
      <select id="riskSelect" class="form-select" style="width:140px; display:inline-block;">
        <option value="">전체</option>
        <option value="1">1 (매우 공격적)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6 (매우 보수적)</option>
      </select>
    </div>

    <!-- 정렬 버튼 -->
    <div class="mb-4">
      <button id="sortReturnBtn" class="btn btn-outline-primary" onclick="sortBy('return')">수익률순 정렬</button>
      <button id="sortRiskBtn" class="btn btn-outline-secondary" onclick="sortBy('risk')">위험등급순 정렬</button>
    </div>

    <!-- 펀드 카드 리스트 -->
    <div id="fundCards" class="row"></div>
  </div>

  <script>
    // 서버에서 전달된 데이터
    const funds = {{ funds | tojson }};
    let filteredFunds = [...funds];
    let activeKeywords = {{ preselected_themes | tojson }};
    let currentRisk = "{{ preselected_risk }}";
    const keywords = {{ theme_keywords | tojson }};

    console.log('preselected_themes:', activeKeywords);

    // 키워드 버튼 동적 생성 + preselected 적용
    const keywordButtonsContainer = document.getElementById('keywordButtons');
    keywords.forEach(k => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-dark btn-sm';
      btn.textContent = k;
      btn.setAttribute('data-keyword', k);
      if (activeKeywords && activeKeywords.includes(k)) {
        btn.classList.add('active');
      }
      btn.onclick = function () {
        const keyword = this.getAttribute('data-keyword');
        if (activeKeywords.includes(keyword)) {
          activeKeywords = activeKeywords.filter(kw => kw !== keyword);
          this.classList.remove('active');
        } else {
          activeKeywords.push(keyword);
          this.classList.add('active');
        }
        filterAndRender();
      };
      keywordButtonsContainer.appendChild(btn);
    });

    // 위험등급 select 박스 preselected 적용
    document.getElementById('riskSelect').value = currentRisk || "";

    // 위험등급 select 변경 시 필터 적용
    document.getElementById('riskSelect').addEventListener('change', function () {
      currentRisk = this.value;
      filterAndRender();
    });

    // 검색 + 키워드 필터 + 위험등급 + 정렬 통합 필터 함수
    function filterAndRender() {
      const keyword = document.getElementById('searchInput').value.toLowerCase();
      filteredFunds = funds.filter(fund => {
        const nameMatch = fund['펀드명'].toLowerCase().includes(keyword);
        const keywordMatch = !activeKeywords.length || activeKeywords.some(k => fund[k] === 1);
        const riskMatch = !currentRisk || fund['투자위험등급'] >= currentRisk;
        return nameMatch && keywordMatch && riskMatch;
      });
      renderCards(filteredFunds);
    }

    // 검색 input 리스너
    document.getElementById('searchInput').addEventListener('input', filterAndRender);

    let currentSort = 'return';

    // 정렬 함수
    function sortBy(criteria) {
      currentSort = criteria;
      document.getElementById('sortReturnBtn').classList.remove('active');
      document.getElementById('sortRiskBtn').classList.remove('active');
      if (criteria === 'return') {
        document.getElementById('sortReturnBtn').classList.add('active');
        filteredFunds.sort((a, b) => a['추천랭킹'] - b['추천랭킹']);
      } else if (criteria === 'risk') {
        document.getElementById('sortRiskBtn').classList.add('active');
        filteredFunds.sort((a, b) => a['투자위험등급'] - b['투자위험등급']);
      }
      renderCards(filteredFunds);
    }

    window.onload = function() {
      document.getElementById('sortReturnBtn').classList.add('active');
      filterAndRender();
    };

    // 카드 렌더링 함수
    function renderCards(data) {
      const container = document.getElementById('fundCards');
      container.innerHTML = '';
      data.slice(0, 30).forEach(fund => {
        const col = document.createElement('div');
        col.className = 'col-12 mb-3';
        col.innerHTML = `
          <div class="card p-3">
            <div class="card-body">
              <h5 class="card-title">
                <a href="/fund/${fund['펀드코드']}">${fund['펀드명']}</a>
              </h5>
              <p class="card-text">
                <span class="badge bg-success">1년 수익률: ${fund['펀드성과정보_1년']}%</span><br>
                <span class="badge bg-rank">펀드점수: ${fund['최종점수']}</span><br>
                <span class="badge bg-rank">펀드랭킹: ${fund['추천랭킹']}</span><br>
                <span class="badge bg-warning text-dark">위험등급: ${fund['투자위험등급']}</span><br>
                <small>운용사: ${fund['운용사명']}</small>
              </p>
            </div>
          </div>`;
        container.appendChild(col);
      });
    }
  </script>
</body>
</html>
