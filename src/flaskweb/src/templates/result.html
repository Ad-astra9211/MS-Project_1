<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>펀드 추천 시스템</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='result_style.css') }}">

</head>

<body>
  <div>
        <a href="/" class="home-btn">home</a>
    </div>
  <div class="container mt-5">
    <h2 class="mb-4">펀드 추천 결과 (상위 30개)</h2>

    <!-- 검색창 -->
    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="펀드명을 검색하세요...">
    </div>

    <!-- 키워드 필터 버튼들 -->
    <div class="mb-4">
      <strong>테마 필터:</strong><br>
      <div id="keywordButtons" class="d-flex flex-wrap gap-2 mt-2"></div>
    </div>

    <!-- 정렬 버튼 -->
    <div class="mb-4">
      <button id="sortReturnBtn" class="btn btn-outline-primary" onclick="sortBy('return')">수익률순 정렬</button>
      <button id="sortRiskBtn" class="btn btn-outline-secondary" onclick="sortBy('risk')">위험등급순 정렬</button>
    </div>

    <!-- 펀드 카드 리스트 -->
    <div id="fundCards" class="row"></div>
  </div>

  <script>
    const funds = {{ funds | tojson }};
    let filteredFunds = [...funds];
    let activeKeywords = [];

    const keywords = ['가치주', '성장주', '중소형주', '글로벌', '자산배분', '4차산업', 'ESG', 
                      '배당주', 'FoFs', '퇴직연금', '고난도금융상품', '절대수익추구', '레버리지', '퀀트'];

    // 키워드 버튼 동적 생성
    const keywordButtonsContainer = document.getElementById('keywordButtons');
    keywords.forEach(k => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-dark btn-sm';
      btn.textContent = k;
      btn.setAttribute('data-keyword', k);
      btn.onclick = function () {
        const keyword = this.getAttribute('data-keyword');
        if (activeKeywords.includes(keyword)) {
          activeKeywords = activeKeywords.filter(k => k !== keyword);
          this.classList.remove('active');
        } else {
          activeKeywords.push(keyword);
          this.classList.add('active');
        }
        filterAndRender();
      };
      keywordButtonsContainer.appendChild(btn);
    });

    // 검색 + 키워드 필터 + 정렬 통합 필터 함수
    function filterAndRender() {
      const keyword = document.getElementById('searchInput').value.toLowerCase();

      filteredFunds = funds.filter(fund => {
        const nameMatch = fund['펀드명'].toLowerCase().includes(keyword);

        const keywordMatch = activeKeywords.length === 0 || activeKeywords.some(k => {
          return fund[k] === 1;
        });

        return nameMatch && keywordMatch;
      });

      renderCards(filteredFunds);
    }

    // 검색 input 리스너
    document.getElementById('searchInput').addEventListener('input', function () {
      filterAndRender();
    });

    let currentSort = 'return';

    // 정렬 함수
    function sortBy(criteria) {
      currentSort = criteria;

      // 버튼 active 스타일 관리
      document.getElementById('sortReturnBtn').classList.remove('active');
      document.getElementById('sortRiskBtn').classList.remove('active');
      if (criteria === 'return') {
        document.getElementById('sortReturnBtn').classList.add('active');
        filteredFunds.sort((a, b) => a['추천랭킹'] - b['추천랭킹']);

      } else if (criteria === 'risk') {
        document.getElementById('sortRiskBtn').classList.add('active');
        filteredFunds.sort((a, b) => a['투자위험등급'] - b['투자위험등급']);
      }
      renderCards(filteredFunds);
    }

    // 페이지 로딩 시 기본 정렬 버튼에 active 적용
    window.onload = function() {
      document.getElementById('sortReturnBtn').classList.add('active');
    };

    // 카드 렌더링 함수
    function renderCards(data) {
  const container = document.getElementById('fundCards');
  container.innerHTML = '';
  data.slice(0, 30).forEach(fund => {
    const col = document.createElement('div');
    col.className = 'col-12 mb-3'; // 한 줄에 하나, 아래에 여백
    col.innerHTML = `
      <div class="card p-3">
        <div class="card-body">
          <h5 class="card-title">
            <a href="/fund/${fund['펀드코드']}">${fund['펀드명']}</a>
          </h5>
          <p class="card-text">
            <span class="badge bg-success">1년 수익률: ${fund['펀드성과정보_1년']}%</span><br>
            <span class="badge bg-rank">펀드점수: ${fund['최종점수']}</span><br>
            <span class="badge bg-rank">펀드랭킹: ${fund['추천랭킹']}</span><br>
            <span class="badge bg-warning text-dark">위험등급: ${fund['투자위험등급']}</span><br>
            <small>운용사: ${fund['운용사명']}</small>
          </p>
        </div>
      </div>`;
    container.appendChild(col);
  });
}


    // 초기 렌더링
    renderCards(filteredFunds);
  </script>
</body>

</html>
